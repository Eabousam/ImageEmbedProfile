---
title: "Multi-Omics Factor Analysis (MOFA) & preranked Gene Enrichment (GSEA) Cancer Imaging"
format: 
  html:
    theme: yeti
    highlight-style: tango
    toc: true
    toc-depth: 3
    toc-floating: true
editor: visual
execute:
  echo: false
  warning: false
  message: false
  include: false
  results: "hide"
  fig-width: 10
  fig-height: 8
  fig-dpi: 300
editor_options: 
  chunk_output_type: inline
---

## Libraries

```{r setup, include=FALSE}
# Load required libraries
library(MOFA2)
library(survival)
library(survminer)
library(curatedTCGAData)
library(fgsea)
library(msigdbr)  
library(enrichplot)
library(ggplot2)
library(dplyr)
library(genekitr)
library(GSVA)
library(Hmisc)
library(pheatmap)
library(DT)
library(tidyverse)

devtools::load_all()

```

#### Analyze MOFA model

```{r, include =TRUE, echo = TRUE}
#| label: load-mofa
# Load trained MOFA model

#mofa_object.trained <- readRDS("mofa_model_with_metadata.rds")
mofa_object.trained <- readRDS("mofa_model_lastembed_with_metadata.rds")
# visualize the model views and samples
plot_data_overview(mofa_object.trained)
samples_metadata(mofa_object.trained) <- metadata_matched
names(metadata_matched)
# Plot factor correlations to check for interdependence issues with the model
plot_factor_cor(mofa_object.trained)


# Plot variance explained
plot_variance_explained(mofa_object.trained, plot_total = TRUE)

print(mofa_object.trained@cache$variance_explained)



```

#### Initial visualizations

```{r}
#| label: mofa-visualization
#| warning: false




# Plot data heatmaps
# using rna seq view
plot_data_heatmap(mofa_object.trained,
                   scale = "row",
                   cluster_cols = FALSE,
                   cluster_rows = FALSE,
                   show_colnames = FALSE,
                   denoise = TRUE,
                   features = 10,
                   view = "RNASeq",
                   factor=1)

# Using embedding view
plot_data_heatmap(mofa_object.trained,
                  factor = 1,
                  view = "Embedding_last",
                  features = 10,
                  cluster_rows = FALSE,
                  cluster_cols = FALSE,
                  show_colnames = FALSE)

# Plot top weights 
plot_top_weights(mofa_object.trained,
                 view = "RNASeq",
                 factor = 1,
                 nfeatures = 10)


# Plot factor colored by pathology stage
plot_factor(mofa_object.trained, 
            factor = 1, 
            add_violin = T,
            dodge = TRUE,
            color_by = "MYH11")

# Plot factor scatter
plot_factor(mofa_object.trained, 
            factor = c(1, 2), 
            color_by = "pathology_T_stage")

plot_top_weights(mofa_object.trained,
                 view = "Embedding_last",
                 factor = 1,
                 nfeatures = 10)

# Correlate factors with clinical variables
correlate_factors_with_covariates(mofa_object.trained, 
                      covariates = c("vital_status.x","pathology_M_stage","tumor_tissue_site"), 
                      plot = "log_pval" )



```

# Factor Contribution

```{r}
# ================================
# Factor Contribution Analysis
# ================================

# 1. Extract loadings (factor weights) for each view
#    MOFA provides loadings per view (e.g. RNASeq, embeddings).
loadings_rnaseq_list <- get_weights(mofa_object.trained, views = "RNASeq")
loadings_embed_list  <- get_weights(mofa_object.trained, views = "Embedding_layer0")

# 2. Convert lists of loadings into numeric matrices
#    Each column corresponds to a factor; each row to a feature (gene, embedding dim).
loadings_rnaseq <- do.call(cbind, loadings_rnaseq_list)
loadings_embed  <- do.call(cbind, loadings_embed_list)

# 3. Compute per-factor contribution
#    Take the sum of *absolute* loadings for each factor.
#    - Absolute value ensures negative/positive weights contribute equally.
#    - This gives a "total magnitude of influence" per factor.
abs_sum_rnaseq <- colSums(abs(loadings_rnaseq))    # RNASeq
abs_sum_embed  <- colSums(abs(loadings_embed))     # Embedding

# 4. Organize results into tidy format for plotting
abs_sum_df <- data.frame(
  Factor    = 1:length(abs_sum_rnaseq),   # factor index
  RNASeq    = abs_sum_rnaseq,
  Embedding = abs_sum_embed
) %>%
  pivot_longer(
    cols = c("RNASeq", "Embedding"), 
    names_to = "View", 
    values_to = "AbsSum"
  )

# 5. Plot per-factor absolute contributions
#    Shows how much each factor is "used" within each view.
ggplot(abs_sum_df, aes(x = Factor, y = AbsSum, fill = View)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("RNASeq" = "blue", "Embedding" = "orange")) +
  labs(
    title = "Sum of Absolute Loadings per Factor",
    x = "Factor",
    y = "Sum of Absolute Loadings"
  ) +
  theme_minimal()

# 6. Compute cumulative contribution across factors
#    Cumulative sum shows how much variance/information is captured
#    as more factors are included in order (Factor1 → Factor15).
cum_sum_rnaseq <- cumsum(abs_sum_rnaseq)
cum_sum_embed  <- cumsum(abs_sum_embed)

# 7. Organize cumulative results into tidy format
cum_sum_df <- data.frame(
  Factor    = 1:length(cum_sum_rnaseq),
  RNASeq    = cum_sum_rnaseq,
  Embedding = cum_sum_embed
) %>%
  pivot_longer(
    cols = c("RNASeq", "Embedding"), 
    names_to = "View", 
    values_to = "Cumsum"
  )

# 8. Plot cumulative contribution
#    Line plot shows the growth of total contribution as factors accumulate.
ggplot(cum_sum_df, aes(x = Factor, y = Cumsum, color = View)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Cumulative Sum of Absolute Loadings Across Factors",
    x = "Factor",
    y = "Cumulative Sum of Absolute Loadings"
  ) +
  theme_minimal()
```

```{r}
plot_weights(mofa_object.trained, 
             view = 2, 
             factor = 3, 
             nfeatures = 10)
# if we have tile embeddings with some coords, we can figure out where they are in the slide image??
```

# PCA interpretation

### Matrices

```{r}
#==============================================================
# 1. Get factor scores
#==============================================================
factor_scores <- get_factors(mofa_object.trained, factors = "all", as.data.frame = FALSE)[[1]] %>%
  as.data.frame() %>%
  tibble::rownames_to_column("patient_id")

#==============================================================
# 2. Load embeddings (last layer only)
#==============================================================
devtools::load_all()  # contains getEmbeddingLayer()

participant_ids <- gsub(".csv$", "", basename(fnames)) %>% 
  strsplit(., "-") %>% 
  sapply(\(x) paste(x[1:3], collapse = "-"))

structure_last <- getEmbeddingLayer(fnames, participant_ids, layer = "last_layer_embed")

#==============================================================
# 3. Align patients between MOFA factors and embeddings
#==============================================================
shared_ids <- intersect(rownames(structure_last), factor_scores$patient_id)

embedding_matched <- structure_last[shared_ids, , drop = FALSE]
factor_scores_matched <- factor_scores[factor_scores$patient_id %in% shared_ids, ]
rownames(factor_scores_matched) <- factor_scores_matched$patient_id
factor_scores_matched <- factor_scores_matched[shared_ids, , drop = FALSE]

#==============================================================
# 4. Table 1: Correlation (factors × embedding dims)
#==============================================================
cor_mat <- cor(
  factor_scores_matched[, -1],
  embedding_matched,
  use = "pairwise.complete.obs"
)

embedding_corr_table <- as.data.frame(cor_mat) %>%
  tibble::rownames_to_column("Factor") %>%
  tidyr::pivot_longer(-Factor,
                      names_to = "Embedding_Dimension",
                      values_to = "Correlation") %>%
  dplyr::mutate(Abs_Corr = abs(Correlation)) %>%
  dplyr::arrange(Factor, desc(Abs_Corr))

#==============================================================
# 5. Table 2: Top weighted embeddings from MOFA
#==============================================================
embedding_weights <- get_weights(mofa_object.trained, view = "Embedding_last", as.data.frame = FALSE)[[1]]

embedding_weight_table <- lapply(seq_len(ncol(embedding_weights)), function(f) {
  tibble::tibble(
    Factor = colnames(embedding_weights)[f],
    Embedding_Dimension = rownames(embedding_weights),
    Weight = embedding_weights[, f],
    Abs_Weight = abs(embedding_weights[, f])
  ) %>%
    dplyr::arrange(desc(Abs_Weight)) %>%
    dplyr::slice_head(n = 20)  # top 20 per factor
}) %>%
  dplyr::bind_rows()

#==============================================================
# Outputs
#==============================================================
head(embedding_corr_table)
head(embedding_weight_table)
```


# Projection of embeddings

```{r}
# matrices
X <- as.matrix(embedding_matched)                 # N x D
Y <- as.matrix(factor_scores_matched[ , -1 ])     # N x F

# center/scale X and Y as needed
Xs <- scale(X)          # mean 0, sd 1
Ys <- scale(Y)

W <- as.matrix(embedding_weights)    # D x F (rownames = embedding dims, colnames = Factor names)

# choose factor j (or loop)
j <- "Factor3"
w_j <- W[, j]                        # length D

# project each sample into that MOFA-derived direction
proj_wj <- Xs %*% w_j                # N x 1

# compare to factor scores
cor(proj_wj, Ys[, j])
plot(
  Ys[, j], proj_wj,
  xlab = paste("MOFA factor", j, "score"),
  ylab = "Projection on embedding weights",
  main = paste("Embedding–Factor association:", j),
  pch = 16, col = "gray40"
)
abline(lm(proj_wj ~ Ys[, j]), col = "red", lwd = 2)


heatmap(embedding_weights, scale = "row",
        xlab = "MOFA factors", ylab = "Embedding dimensions",
        main = "Embedding–Factor weight structure")



```


# Analyse clusters of embeddings

```{r}
# Clean cluster analysis for Factor3 with both GSEA and GSVA
analyze_factor3_clusters <- function() {
  
  # 1. Get projections and actual scores
  proj <- Xs %*% W[, "Factor3"]
  actual_scores <- Ys[, "Factor3"]
  
  # 2. Simple cluster assignment
  clusters <- ifelse(proj > median(proj), "Cluster1", "Cluster2")
  
  # 3. Create results with metadata and pathways
  results_df <- data.frame(
    sample_id = rownames(Xs),
    projection = proj,
    factor_score = actual_scores,
    cluster = clusters
  )
  
  # 4. Add key metadata
  metadata <- samples_metadata(mofa_object.trained)
  key_metadata <- metadata[, c("patientID", "tumor_tissue_site", "pathologic_stage", 
                              "pathology_T_stage", "pathology_N_stage", "pathology_M_stage",
                              "gender", "histological_type")]
  
  results_df <- results_df %>%
    left_join(key_metadata, by = c("sample_id" = "patientID"))
  
  # 5. Add BOTH GSEA and GSVA pathways for Factor3
  # GSVA pathways (from your correlation analysis)
  gsva_pathways <- get_top_gsva_pathways()
  gsva_data <- as.data.frame(t(ssgsea_hallmark[gsva_pathways, ]))
  gsva_data$sample_id <- rownames(gsva_data)
  
  results_df <- results_df %>%
    left_join(gsva_data, by = "sample_id")
  
  return(results_df)
}

# Get top GSVA pathways for Factor3 (including estrogen)
get_top_gsva_pathways <- function() {
  factor3_gsva <- hallmark_interpret[["Factor3"]]
  
  # Get top 5 positive and 5 negative pathways from GSVA
  top_positive <- head(factor3_gsva$positive_pathways, 5)
  top_negative <- head(factor3_gsva$negative_pathways, 5)
  
  return(c(top_positive, top_negative))
}

# Print comprehensive Factor3 interpretation
print_factor3_interpretation <- function() {
  cat("=== COMPREHENSIVE FACTOR3 INTERPRETATION ===\n\n")
  
  cat("GSEA RESULTS (Gene-level enrichment):\n")
  cat("-------------------------------------\n")
  cat("• Epithelial-mesenchymal transition (p=5.2e-29)\n")
  cat("• Myogenesis (p=2.7e-11)\n")
  cat("• Oxidative phosphorylation (p=3.1e-09)\n")
  cat("• MYC targets V1 (p=3.0e-05)\n")
  cat("• Apical junction (p=9.4e-05)\n")
  cat("• Angiogenesis (p=3.8e-04)\n\n")
  
  cat("GSVA RESULTS (Pathway activity correlation):\n")
  cat("--------------------------------------------\n")
  cat("POSITIVE correlations:\n")
  cat("• Epithelial-mesenchymal transition (r=0.23)\n")
  cat("• Myogenesis (r=0.21)\n")
  cat("• Angiogenesis (r=0.18)\n")
  cat("• Apical junction (r=0.17)\n")
  cat("• Coagulation (r=0.16)\n\n")
  
  cat("NEGATIVE correlations:\n")
  cat("• ESTROGEN_RESPONSE_LATE (r=-0.21) ***\n")
  cat("• Heme metabolism (r=-0.12)\n")
  cat("• Spermatogenesis (r=-0.06)\n")
  cat("• Allograft rejection (r=-0.06)\n")
  cat("• Unfolded protein response (r=-0.05)\n\n")
}

# Enhanced cluster analysis
run_factor3_cluster_analysis <- function() {
  cat("=== FACTOR3 CLUSTER ANALYSIS ===\n\n")
  
  # Print pathway context first
  print_factor3_interpretation()
  
  # 1. Get cluster data
  cluster_data <- analyze_factor3_clusters()
  
  # 2. Analyze clinical differences
  cat("CLINICAL DIFFERENCES BETWEEN CLUSTERS:\n")
  cat("--------------------------------------\n")
  analyze_clinical_differences(cluster_data)
  
  # 3. Analyze pathway differences
  cat("\nPATHWAY DIFFERENCES BETWEEN CLUSTERS:\n")
  cat("-------------------------------------\n")
  pathway_diffs <- analyze_pathway_differences(cluster_data)
  
  # 4. Create visualizations
  cat("\nGENERATING PLOTS...\n")
  plots <- create_cluster_plots(cluster_data)
  
  return(list(
    cluster_data = cluster_data,
    pathway_differences = pathway_diffs,
    plots = plots
  ))
}

# Clinical differences analysis
analyze_clinical_differences <- function(cluster_data) {
  
  # Test tumor tissue site (colon vs rectal)
  if("tumor_tissue_site" %in% colnames(cluster_data)) {
    site_table <- table(cluster_data$cluster, cluster_data$tumor_tissue_site)
    print(site_table)
    
    fisher_p <- fisher.test(site_table)$p.value
    cat("Tumor site Fisher p-value:", round(fisher_p, 4), "\n")
  }
}

# Pathway differences analysis - focused on key pathways
analyze_pathway_differences <- function(cluster_data) {
  
  # Focus on key pathways from both GSEA and GSVA
  key_pathways <- c(
    "HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION",
    "HALLMARK_MYOGENESIS", 
    "HALLMARK_ANGIOGENESIS",
    "HALLMARK_ESTROGEN_RESPONSE_LATE",
    "HALLMARK_OXIDATIVE_PHOSPHORYLATION"
  )
  
  pathway_results <- data.frame()
  
  for(pathway in key_pathways) {
    if(pathway %in% colnames(cluster_data)) {
      cluster1_vals <- cluster_data[[pathway]][cluster_data$cluster == "Cluster1"]
      cluster2_vals <- cluster_data[[pathway]][cluster_data$cluster == "Cluster2"]
      
      t_test <- t.test(cluster1_vals, cluster2_vals)
      
      pathway_results <- rbind(pathway_results, data.frame(
        pathway = pathway,
        cluster1_mean = mean(cluster1_vals, na.rm = TRUE),
        cluster2_mean = mean(cluster2_vals, na.rm = TRUE),
        mean_difference = mean(cluster1_vals, na.rm = TRUE) - mean(cluster2_vals, na.rm = TRUE),
        p_value = t_test$p.value
      ))
    }
  }
  
  # Sort by significance
  pathway_results <- pathway_results[order(pathway_results$p_value), ]
  
  # Print results
  print(pathway_results)
  
  return(pathway_results)
}

# Create focused visualizations
create_cluster_plots <- function(cluster_data) {
  library(ggplot2)
  library(patchwork)
  
  plots <- list()
  
  # Plot 1: Basic cluster scatter
  plots$scatter_basic <- ggplot(cluster_data, aes(x = factor_score, y = projection, color = cluster)) +
    geom_point(alpha = 0.7, size = 2) +
    labs(title = "Factor3: Two Distinct Clusters",
         x = "MOFA Factor3 Score", 
         y = "Embedding Projection") +
    theme_minimal()
  
  # Plot 2: Estrogen response by cluster (key finding)
  if("HALLMARK_ESTROGEN_RESPONSE_LATE" %in% colnames(cluster_data)) {
    plots$estrogen_boxplot <- ggplot(cluster_data, aes(x = cluster, y = HALLMARK_ESTROGEN_RESPONSE_LATE, fill = cluster)) +
      geom_boxplot(alpha = 0.7) +
      labs(title = "Key Finding: Estrogen Response by Cluster",
           y = "Estrogen Response Activity") +
      theme_minimal() +
      theme(legend.position = "none")
  }
  
  # Plot 3: EMT by cluster (GSEA top pathway)
  if("HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION" %in% colnames(cluster_data)) {
    plots$emt_boxplot <- ggplot(cluster_data, aes(x = cluster, y = HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION, fill = cluster)) +
      geom_boxplot(alpha = 0.7) +
      labs(title = "GSEA Top Pathway: EMT by Cluster",
           y = "EMT Activity") +
      theme_minimal() +
      theme(legend.position = "none")
  }
  
  # Plot 4: Tumor site distribution
  if("tumor_tissue_site" %in% colnames(cluster_data)) {
    plots$site_bar <- ggplot(cluster_data, aes(x = cluster, fill = tumor_tissue_site)) +
      geom_bar(position = "fill") +
      labs(title = "Tumor Site Distribution by Cluster",
           y = "Proportion") +
      theme_minimal()
  }
  
  return(plots)
}

# Run the analysis
results <- run_factor3_cluster_analysis()

# Display cluster summary
cat("\nCLUSTER SUMMARY:\n")
print(results$cluster_data %>% 
        group_by(cluster) %>% 
        summarise(
          n_samples = n(),
          avg_factor_score = mean(factor_score),
          avg_projection = mean(projection)
        ))

# Show plots
results$plots$scatter_basic
if(!is.null(results$plots$estrogen_boxplot)) results$plots$estrogen_boxplot
if(!is.null(results$plots$emt_boxplot)) results$plots$emt_boxplot  
if(!is.null(results$plots$site_bar)) results$plots$site_bar
```


```{r}
# Create focused visualizations
create_focused_plots <- function(cluster_data) {
  library(ggplot2)
  library(patchwork)
  
  # Plot 1: Estrogen Response by Cluster (most significant)
  p1 <- ggplot(cluster_data, aes(x = cluster, y = HALLMARK_ESTROGEN_RESPONSE_LATE, fill = cluster)) +
    geom_boxplot(alpha = 0.7) +
    labs(title = "Strongest Signal: Estrogen Response",
         y = "Estrogen Response Activity") +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Plot 2: Angiogenesis by Cluster  
  p2 <- ggplot(cluster_data, aes(x = cluster, y = HALLMARK_ANGIOGENESIS, fill = cluster)) +
    geom_boxplot(alpha = 0.7) +
    labs(title = "Angiogenesis Difference",
         y = "Angiogenesis Activity") +
    theme_minimal() +
    theme(legend.position = "none")
  
  # Plot 3: Tumor stage distribution
  p3 <- ggplot(cluster_data, aes(x = cluster, fill = pathologic_stage)) +
    geom_bar(position = "fill") +
    labs(title = "Stage Distribution by Cluster",
         y = "Proportion") +
    theme_minimal()
  
  # Plot 4: Tumor site by cluster
  p4 <- ggplot(cluster_data, aes(x = cluster, fill = tumor_tissue_site)) +
    geom_bar(position = "fill") +
    labs(title = "Tumor Site by Cluster", 
         y = "Proportion") +
    theme_minimal()
  
  return((p1 + p2) / (p3 + p4))
}

# Generate focused plots
focused_plots <- create_focused_plots(results$cluster_data)
print(focused_plots)
```






# Gene set Analysis

```         
•   GSEA (Subramanian et al., 2005) > standard for testing global enrichment. (FGSEA fast preranked gene set enrichment analysis)
•   GSVA (Hänzelmann et al., 2013) > extends this by providing sample-wise enrichment scores, enabling downstream associations with phenotypes or latent factors.
```

## Gene sets

```{r, GSEA, include=TRUE, echo=TRUE}

# get Hallmark gene sets
#50 curated gene sets representing broad, well-defined biological processes (e.g., MYC targets, E2F targets, KRAS signaling, apoptosis)
pathways_hallmark <- msigdbr(species = "Homo sapiens", collection = "H") %>%
  split(x = .$gene_symbol, f = .$gs_name)

# get c2 gene sets
# Gene sets representing signatures of oncogene activation or inactivation (e.g., KRAS, MYC, E2F, PTEN loss).
pathways_c6 <- msigdbr(species = "Homo sapiens", collection = "C6") %>%
  split(x = .$gene_symbol, f = .$gs_name)

# get c2 gene sets
#Pathway databases and expert-curated gene sets, subdivided into:
##CGP (chemical/genetic perturbations) → genes responsive to drugs or perturbations.
##CP (canonical pathways) → pathways from KEGG, Reactome, BioCarta.
pathways_c2 <- msigdbr(species = "Homo sapiens", collection = "C2") %>%
  split(x = .$gene_symbol, f = .$gs_name)




```

## Run FGSEA

```{r}

## Run FGSEA for all factors

#gene set enrichment analysis (GSEA) to identify biological pathways and programs associated with the latent factors
# Extract weights for Factor 1 in RNASeq
# we extracted the feature weights for the top contributing genes in the rnaseq view, which represent the genes most associated with factor 1

all_weights <- get_weights(mofa_object.trained, 
                           views = "RNASeq", 
                           factors = "all", 
                           as.data.frame = TRUE)

# For each factor, run GSEA to understand biological meaning
factor_interpretation <- list()

for(factor_id in unique(all_weights$factor)) {
  # factor_id already has the form "Factor1", "Factor2", etc.
  
  # Get weights for this factor
  factor_weights <- all_weights[all_weights$factor == factor_id, ]
  
  # Create ranked list
  ranks <- factor_weights$value
  names(ranks) <- factor_weights$feature
  ranks <- sort(ranks, decreasing = TRUE)
  
  # Run GSEA on multiple gene set collections
  hallmark_res <- fgsea(pathways_hallmark, ranks, minSize = 15, maxSize = 500)
  c2_res      <- fgsea(pathways_c2, ranks, minSize = 15, maxSize = 500)
  c6_res      <- fgsea(pathways_c6, ranks, minSize = 15, maxSize = 500)
  
  # Store top pathways for interpretation
  factor_interpretation[[factor_id]] <- list(
    hallmark_top = hallmark_res[order(hallmark_res$pval), ][1:20, ],
    c2_top       = c2_res[order(c2_res$pval), ][1:20, ],
    c6_top       = c6_res[order(c6_res$pval), ][1:20, ]
  )
}


# Check any of the gene sets with factors
factor_interpretation$Factor3$c2_top

```

**Explanation of GSEA output (fgsea):**

-   **pathway** – Name of the gene set tested (e.g., Hallmark pathways).\

-   **pval** – Raw p-value from the enrichment test.\

-   **padj** – Adjusted p-value (FDR corrected).\

-   **ES (Enrichment Score)** – Degree to which a gene set is overrepresented at the top or bottom of the ranked list.\

-   **NES (Normalized Enrichment Score)** – Enrichment score normalized for gene set size, used to compare across gene sets.\

-   **size** – Number of genes in the pathway that overlap with the ranked list.\

-   **leadingEdge** – Subset of genes that contribute most to the enrichment signal.

-   Hallmark pathways from the GSEA results, ranked by normalized enrichment score (NES), with bars colored by whether the adjusted p-value (FDR) is significant (\< 0.05).

-   MYC targets (V1, V2), E2F targets, and KRAS signaling are strongly negatively enriched, suggesting suppression of cell-cycle–related and oncogenic signaling programs in the context of the factors identified by MOFA.

    -   MYC is a master regulator of proliferation, metabolism, and growth (Dang, Cell, 2012).

-   epithelial–mesenchymal transition (EMT), inflammatory response, interferon gamma response, and allograft rejection. This points to activation of immune and stromal programs.

## Factor Enrichment plot

```{r, include=TRUE}
# Plot enrichment for Factor1, top Hallmark pathway
enrichment_plot <- plot_factor_enrichment("Factor1", pathway_collection = "hallmark", top_n = 3, all_weights = all_weights)

# Display the plot
if(!is.null(enrichment_plot)) {
  print(enrichment_plot[[1]])
}
```

-   GSEA identified HALLMARK_MYC_TARGETS_V1 as one of the most significantly enriched pathways (FDR q \< 1e-28), indicating a central role of MYC-driven transcriptional programs in our dataset. Complementarily, GSVA revealed that MYC target activity varies across samples and is negatively correlated with MOFA Factor 1, suggesting that MYC activation is antagonistic to the biological processes captured by this factor.

## Run GSVA

```{r}
# Extract RNA-seq expression from MOFA
rna_se <- get_data(mofa_object.trained, view = "RNASeq")[[1]]  # first group if multiple
expr_mat <- as.matrix(rna_se$group1)  # genes x samples
# Hallmark
param_hallmark <- ssgseaParam(expr_mat, pathways_hallmark)
ssgsea_hallmark <- gsva(param_hallmark, verbose = FALSE)

# run GSVA on C2 and C6 for comprehensive coverage
param_c2 <- ssgseaParam(expr_mat, pathways_c2)
ssgsea_c2 <- gsva(param_c2, verbose = FALSE)

param_c6 <- ssgseaParam(expr_mat, pathways_c6) 
ssgsea_c6 <- gsva(param_c6, verbose = FALSE)

# Correlate ALL factors with ALL pathway collections
correlate_factors_pathways <- function(factor_mat, pathway_mat, pathway_name) {
  common_samples <- intersect(rownames(factor_mat), colnames(pathway_mat))
  factor_aligned <- factor_mat[common_samples, ]
  pathway_aligned <- t(pathway_mat[, common_samples])
  
  cor_matrix <- cor(factor_aligned, pathway_aligned, method = "spearman")
  return(cor_matrix)
}

# Get factor matrix (samples x factors)
fmat <- get_factors(mofa_object.trained, factors = "all", as.data.frame = FALSE)[[1]]

# Compute correlations
hallmark_cor <- correlate_factors_pathways(fmat, ssgsea_hallmark, "Hallmark")
c2_cor <- correlate_factors_pathways(fmat, ssgsea_c2, "C2")
c6_cor <- correlate_factors_pathways(fmat, ssgsea_c6, "C6")

# Find top correlated pathways for each factor
interpret_factors <- function(cor_matrix, pathways, n_top = 20) {
  factor_interpretations <- list()
  
  for(i in 1:nrow(cor_matrix)) {
    factor_cor <- cor_matrix[i, ]
    # Get top positive and negative correlations
    top_pos <- head(sort(factor_cor, decreasing = TRUE), n_top)
    top_neg <- head(sort(factor_cor, decreasing = FALSE), n_top)
    
    factor_interpretations[[rownames(cor_matrix)[i]]] <- list(
      positive_pathways = names(top_pos),
      positive_cor = top_pos,
      negative_pathways = names(top_neg), 
      negative_cor = top_neg
    )
  }
  return(factor_interpretations)
}

hallmark_interpret <- interpret_factors(hallmark_cor, pathways_hallmark)
c2_interpret <- interpret_factors(c2_cor, pathways_c2)
c6_interpret <- interpret_factors(c6_cor, pathways_c6)



```

# Latent Factor Visualization

## geom_col plot

```{r}
## geom_col plot

# Function to return individual plots
plot_factor_separate <- function(factor_id,
                                 gsea_collection = "hallmark",
                                 gsva_collection = "hallmark",
                                 max_pathways = 20) {
  
  plots <- list()
  
  # --- GSEA ---
  p_gsea <- plot_gsea(factor_id, gsea_collection, max_pathways)
  if (!is.null(p_gsea)) {
    p_gsea <- p_gsea +
      theme_minimal() +
      theme(
        axis.text.y = element_text(size = 9, hjust = 1),
        axis.title = element_blank(),
        plot.margin = margin(5, 10, 5, 50)
      ) +
      ggtitle(paste("Factor:", factor_id, "- GSEA"))
  } else {
    p_gsea <- ggplot() + theme_void() + ggtitle(paste(factor_id, "GSEA missing"))
  }
  plots[["GSEA"]] <- p_gsea
  
  # --- GSVA ---
  p_gsva <- plot_gsva(factor_id, gsva_collection, max_pathways)
  if (!is.null(p_gsva)) {
    p_gsva <- p_gsva +
      theme_minimal() +
      theme(
        axis.text.y = element_text(size = 4, hjust = 1),
        axis.title = element_blank(),
        plot.margin = margin(5, 10, 5, 50)
      ) +
      ggtitle(paste("Factor:", factor_id, "- GSVA"))
  } else {
    p_gsva <- ggplot() + theme_void() + ggtitle(paste(factor_id, "GSVA missing"))
  }
  plots[["GSVA"]] <- p_gsva
  
  return(plots)
}

# Factors to plot
top_factors <- c("Factor1", "Factor2", "Factor3")

# Generate and print each plot separately
for (f in top_factors) {
  plots <- plot_factor_separate(f, gsea_collection = "c2", gsva_collection = "c2", max_pathways = 8)
  
  print(plots[["GSEA"]])
  print(plots[["GSVA"]])
}
```

## Heatmap plot

```{r}
library(RColorBrewer)
# GSEA heatmap for Hallmark pathways
plot_gsea_heatmap("hallmark", top_n_pathways = 40)

# GSVA heatmap for Hallmark pathways
plot_gsva_heatmap("hallmark", top_n_pathways = 30)

# You can switch to "c2" or "c6"
plot_gsea_heatmap("c2", top_n_pathways = 20)
plot_gsva_heatmap("c2", top_n_pathways = 20)



```

# Table

```{r}
# ---- Integrated interpret_factor function ----
interpret_factor <- function(factor_id,
                             top_n_pathways = 10,
                             top_n_genes = 10,
                             gsva_collections = c("hallmark","c2","c6"),
                             gsea_collections = c("hallmark","c2","c6")) {
  
  # --- Top genes ---
  all_weights <- get_weights(mofa_object.trained, views="RNASeq", factors=factor_id, as.data.frame=TRUE)
  top_genes <- head(all_weights[order(-abs(all_weights$value)), ], top_n_genes)
  
  # --- FGSEA ---
  gsea_summary <- list()
  ranks <- setNames(all_weights$value, all_weights$feature)
  ranks <- sort(ranks, decreasing = TRUE)
  
  if("hallmark" %in% gsea_collections) {
    res <- fgsea(pathways_hallmark, ranks, minSize=15, maxSize=500)
    gsea_summary$hallmark <- if(nrow(res) > 0) res[order(res$pval), ][1:top_n_pathways, ] else NULL
  }
  if("c2" %in% gsea_collections) {
    res <- fgsea(pathways_c2, ranks, minSize=15, maxSize=500)
    gsea_summary$c2 <- if(nrow(res) > 0) res[order(res$pval), ][1:top_n_pathways, ] else NULL
  }
  if("c6" %in% gsea_collections) {
    res <- fgsea(pathways_c6, ranks, minSize=15, maxSize=500)
    gsea_summary$c6 <- if(nrow(res) > 0) res[order(res$pval), ][1:top_n_pathways, ] else NULL
  }
  
  # --- GSVA correlations ---
  gsva_summary <- list()
  if("hallmark" %in% gsva_collections) gsva_summary$hallmark <- hallmark_interpret[[factor_id]]
  if("c2" %in% gsva_collections)       gsva_summary$c2 <- c2_interpret[[factor_id]]
  if("c6" %in% gsva_collections)       gsva_summary$c6 <- c6_interpret[[factor_id]]
  
  list(
    top_genes = top_genes,
    gsea_summary = gsea_summary,
    gsva_summary = gsva_summary
  )
}

create_summary_table <- function(factor_ids = paste0("Factor", 1:10),
                                 top_n_pathways = 5,
                                 top_n_genes = 10,
                                 interpretations = NULL) {
  
  # Pre-define all possible columns to ensure consistency
  all_gsea_cols <- c("Top_HALLMARK_GSEA_Pathways", "Top_C2_GSEA_Pathways", "Top_C6_GSEA_Pathways")
  all_gsva_cols <- c("Top_HALLMARK_GSVA_Pathways", "Top_C2_GSVA_Pathways", "Top_C6_GSVA_Pathways")
  
  reports <- lapply(factor_ids, function(fid) {
    
    # ---- Get interpretation outputs ----
    out <- interpret_factor(fid,
                            top_n_pathways = top_n_pathways,
                            top_n_genes = top_n_genes)
    
    # ---- Top genes ----
    top_genes_text <- NA
    if(!is.null(out$top_genes) && nrow(out$top_genes) > 0) {
      top_genes_vec <- as.character(out$top_genes$feature)
      if(is.list(top_genes_vec)) top_genes_vec <- unlist(top_genes_vec)
      top_genes_text <- paste(head(top_genes_vec, top_n_genes), collapse = ", ")
    }
    
    # ---- GSEA columns ----
    gsea_cols <- setNames(rep(NA, length(all_gsea_cols)), all_gsea_cols)
    
    for(col in names(out$gsea_summary)) {
      col_name <- paste0("Top_", toupper(col), "_GSEA_Pathways")
      res <- out$gsea_summary[[col]]
      if(!is.null(res) && nrow(res) > 0) {
        res <- res[order(res$pval), , drop = FALSE]
        res <- head(res, min(top_n_pathways, nrow(res)))
        gsea_cols[col_name] <- paste(res$pathway, "(p=", signif(res$pval, 2), ")", collapse = "; ")
      }
    }
    
    # ---- GSVA columns ----
    gsva_cols <- setNames(rep(NA, length(all_gsva_cols)), all_gsva_cols)
    
    for(col in names(out$gsva_summary)) {
      col_name <- paste0("Top_", toupper(col), "_GSVA_Pathways")
      cor_vec <- out$gsva_summary[[col]]
      if(!is.null(cor_vec) && length(cor_vec) > 0) {
        # Ensure we have a named numeric vector
        if(is.data.frame(cor_vec)) {
          if(ncol(cor_vec) == 1) {
            cor_vec <- setNames(cor_vec[,1], rownames(cor_vec))
          } else {
            cor_vec <- setNames(cor_vec[,1], rownames(cor_vec)) # Take first column
          }
        }
        if(is.list(cor_vec)) cor_vec <- unlist(cor_vec)
        
        # Get top correlations
        if(length(cor_vec) > 0 && !is.null(names(cor_vec))) {
  cor_vec <- suppressWarnings(as.numeric(cor_vec))
  names(cor_vec) <- names(out$gsva_summary[[col]])  # restore names if lost
  cor_vec <- cor_vec[!is.na(cor_vec)]
  if(length(cor_vec) > 0) {
    top_cor <- head(sort(cor_vec, decreasing = TRUE), top_n_pathways)
    gsva_cols[col_name] <- paste(names(top_cor), "[cor=", signif(top_cor, 2), "]", collapse = "; ")
  }
}
      }
    }
    
    # ---- Combine all into one row ----
    result_row <- data.frame(
      Factor = fid,
      Top_Genes = top_genes_text,
      Interpretation = if(!is.null(interpretations) && fid %in% names(interpretations)) interpretations[[fid]] else NA,
      stringsAsFactors = FALSE
    )
    
    # Add GSEA and GSVA columns in consistent order
    for(col_name in all_gsea_cols) {
      result_row[[col_name]] <- gsea_cols[col_name]
    }
    for(col_name in all_gsva_cols) {
      result_row[[col_name]] <- gsva_cols[col_name]
    }
    
    return(result_row)
  })
  
  # Combine all rows
  final_table <- do.call(rbind, reports)
  return(final_table)
}


# Add the interpretation based on the table
interpretations <- list(
  Factor1 = "Oncogenic proliferation program characterized by MYC/E2F-driven cell cycle activity, KRAS/TGF-β signaling, and smooth muscle/stromal gene expression (MYH11, DES, CNN1)",
  
  Factor2 = "oxidative stress response with immune activation features (allograft rejection, interferon signaling) and angiogenesis regulation",
  
  Factor3 = "Metabolic reprogramming program centered on oxidative phosphorylation and myogenesis, with epithelial-mesenchymal transition and coagulation pathway activation",
  
  Factor4 = "Mitotic and metabolic axis featuring spindle assembly, oxidative phosphorylation, and adipogenesis, with strong autophagy and amino acid metabolism components",
  
  Factor5 = "Advanced cancer progression signature with strong EMT, fatty acid metabolism, and matrisome remodeling, indicative of invasive tumor phenotype",
  
  Factor6 = "Immune-excluded tumor microenvironment characterized by interferon response, glycolytic metabolism, mTOR signaling, and hypoxia adaptation",
  
  Factor7 = "Cell cycle checkpoint and mTOR signaling program with weak immune associations, potentially representing proliferative but immunologically quiet tumors",
  
  Factor8 = "Inflammatory cancer phenotype with EMT, TNFα/NF-κB signaling, KRAS activation, and extracellular matrix organization",
  
  Factor9 = "Antiviral immune response signature featuring strong interferon signaling, cytokine activity (CXCL9, GZMA), and regulated cell death pathways",
  
  Factor10 = "Differentiation and secretory program with EMT, androgen response, protein secretion, and weak WNT/β-catenin signaling"
)
# 1. Create the table data first
all_factors_table <- create_summary_table(
  factor_ids = paste0("Factor", 1:10),
  top_n_pathways = 5,
  top_n_genes = 10,
  interpretations = interpretations
)

```

# Interpretation Report

```{r}
# Interpretation Report

rmd_html <- "MOFA_factor_summary.Rmd"

writeLines(c(
  "---",
  "title: '<center>MOFA Factor Analysis: Biological Pathway Associations</center>'",
  "output:",
  "  html_document:",
  "    toc: true",
  "    toc_float: true",
  "    toc_depth: 3",
  "    number_sections: true",
  "    theme: journal",
  "    css: styles.css",
  "    df_print: paged",
  "---",
  "",
  "```{r setup, include=FALSE}",
  "knitr::opts_chunk$set(",
  "  echo = FALSE, warning = FALSE, message = FALSE,",
  "  fig.align = 'center',",
  "  fig.width = 7, fig.height = 5,",
  "  out.width = '100%',",
  "  fig.show = 'asis'",
  ")",
  "library(kableExtra)",
  "library(dplyr)",
  "library(DT)",
  "library(patchwork)",
  "library(ggplot2)",
  "```",
  "",
  "<style>",
  "@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Merriweather:wght@400;700&display=swap');",
  "",
  "body {",
  "  font-family: 'Roboto', sans-serif;",
  "  line-height: 1.7;",
  "  color: #2c3e50;",
  "  background-color: #fafafa;",
  "  max-width: 1100px;",
  "  margin: auto;",
  "  padding: 20px;",
  "}",
  "h1, h2, h3 {",
  "  font-family: 'Merriweather', serif;",
  "  color: #1a5276;",
  "  margin-top: 2em;",
  "  padding-bottom: 0.3em;",
  "  border-bottom: 2px solid #5dade2;",
  "}",
  "table {",
  "  border-collapse: collapse;",
  "  margin: 1em 0;",
  "}",
  "th {",
  "  background-color: #5dade2;",
  "  color: #fff;",
  "  padding: 8px;",
  "  text-align: left;",
  "}",
  "td {",
  "  padding: 8px;",
  "  border-bottom: 1px solid #ddd;",
  "}",
  ".table-caption {",
  "  font-weight: 600;",
  "  font-size: 1.1em;",
  "  color: #34495e;",
  "  margin-bottom: 8px;",
  "}",
  "code, pre {",
  "  font-family: 'Fira Code', monospace;",
  "  background-color: #f4f6f6;",
  "  padding: 2px 6px;",
  "  border-radius: 4px;",
  "}",
  "</style>",
  "",
"# Introduction",
"",
"Using processed whole slide images (WSIs) from ProviGigaPath, we extracted image embeddings to numerically represent visual tissue features. These embeddings were matched to curated TCGA multi-omics data, including RNA-seq, allowing integration of histology and molecular profiles.",
"",
"MOFA (Multi-Omics Factor Analysis) was applied to jointly analyze the embeddings and molecular data, identifying latent factors that capture shared variation across modalities. We then correlated embedding weights with factor loadings to determine which visual features aligned with specific latent factors.",
"",
"Biological interpretation was achieved by applying FGSEA (Fast Gene Set Enrichment Analysis) and GSVA (Gene Set Variation Analysis) to the RNA-seq factor loadings, uncovering pathways associated with each factor. This pipeline systematically links histology image patterns to molecular mechanisms in an interpretable way.",
"",
"# Data Sources and Analytical Pipeline",
"- **MOFA Model**: Trained on multi-omics views: Prov-GigaPath WSI Embedding and RNAseq data",
"- **Pathway Databases**: MSigDB Hallmark, C2 (Curated), C6 (Oncogenic)",
"- **Analysis Methods**: GSEA (preranked), GSVA (sample-level)",
"- **Pipeline**:",
"  1. Extract factor weights from MOFA model",
"  2. Perform preranked GSEA on factor loadings",
"  3. Calculate pathway activity scores using GSVA",
"  4. Correlate factors with pathway activities",
"",
  "# Latent Factor Visualization",
  "",
  "## MOFA output",
  "```{r factor-plots, fig.width=12, fig.height=8}",
  "print(plot_variance_explained(mofa_object.trained, plot_total = TRUE))",
  "## Heatmaps",
  "```{r heatmap-plots, fig.width=12, fig.height=10}",
  "if (exists('plot_gsea_heatmap')) {",
  "  print(plot_gsea_heatmap('hallmark', top_n_pathways = 30))",
  "  print(plot_gsva_heatmap('hallmark', top_n_pathways = 20))",
  "  print(plot_gsea_heatmap('c2', top_n_pathways = 30))",
  "  print(plot_gsva_heatmap('c2', top_n_pathways = 20))",
  "  print(plot_gsea_heatmap('c6', top_n_pathways = 20))",
  "  print(plot_gsva_heatmap('c6', top_n_pathways = 20))",
  "}",
  "```",
  "",
  "## Summary of Factor Interpretations",
  "```{r summary-table, results='asis'}",
  "if (exists('all_factors_table')) {",
  "  kable(all_factors_table, format = 'html', escape = FALSE,",
  "        caption = '<strong>Table 1: MOFA Factor Biological Interpretations</strong>') %>%",
  "    kable_styling(",
  "      bootstrap_options = c('striped', 'hover', 'condensed'),",
  "      full_width = TRUE,",
  "      font_size = 12,",
  "      position = 'center'",
  "    ) %>%",
  "    column_spec(1, bold = TRUE, width = '80px') %>%",
  "    column_spec(2, width = '100px') %>%",
  "    column_spec(3, width = '200px') %>%",
  "    column_spec(4:ncol(all_factors_table), width = '250px') %>%",
  "    scroll_box(width = '100%', height = '500px')",
  "}",
  "```",
  "",
  "## Embedding–Factor Correlation Table",
  "",
  "```{r embedding-factor-correlation, results='asis'}",
  "if (exists('embedding_corr_table')) {",
  "  top_corr_table <- embedding_corr_table %>%",
  "    group_by(Factor) %>%",
  "    slice_max(order_by = Abs_Corr, n = 20) %>%",
  "    ungroup()",
  "",
  "  kable(top_corr_table, format = 'html', escape = FALSE,",
  "        caption = '<strong>Table 3: Top Correlated Embeddings per Factor</strong>') %>%",
  "    kable_styling(",
  "      bootstrap_options = c('striped', 'hover', 'condensed'),",
  "      full_width = TRUE,",
  "      font_size = 12,",
  "      position = 'center'",
  "    ) %>%",
  "    scroll_box(width = '100%', height = '500px')",
  "}",
  "```",
  "",
  "## MOFA Embedding Weight Table",
  "",
  "```{r embedding-weight-table, results='asis'}",
  "if (exists('embedding_weight_table')) {",
  "  kable(embedding_weight_table, format = 'html', escape = FALSE,",
  "        caption = '<strong>Table 4: Top Weighted Embeddings per Factor (from MOFA Model)</strong>') %>%",
  "    kable_styling(",
  "      bootstrap_options = c('striped', 'hover', 'condensed'),",
  "      full_width = TRUE,",
  "      font_size = 12,",
  "      position = 'center'",
  "    ) %>%",
  "    scroll_box(width = '100%', height = '500px')",
  "}",
  "```",
  "",
   "## Embedding–Factor Projection Plots for Factors 1, 3, 5",
  "```{r embedding-projections, fig.width=7, fig.height=5}",
  "selected_factors <- c('Factor1', 'Factor3', 'Factor5')",
  "Xs <- scale(as.matrix(embedding_matched))",
  "Ys <- scale(as.matrix(factor_scores_matched[, -1]))",
  "W  <- as.matrix(embedding_weights)",
  "for (j in selected_factors) {",
  "  w_j <- W[, j]",
  "  proj_wj <- Xs %*% w_j",
  "  cor_val <- cor(proj_wj, Ys[, j])",
  "  plot(Ys[, j], proj_wj,",
  "       xlab = paste('MOFA factor', j, 'score'),",
  "       ylab = 'Projection on embedding weights',",
  "       main = paste('Embedding–Factor association:', j, '\\nCorrelation =', round(cor_val, 3)),",
  "       pch = 16, col = 'gray40')",
  "  abline(lm(proj_wj ~ Ys[, j]), col = 'red', lwd = 2)",
  "}",
  "```",
  "",
  "```{r embedding-weights-heatmap, fig.width=8, fig.height=6}",
  "heatmap(W[, selected_factors], scale = 'row',",
  "        xlab = 'Selected MOFA factors',",
  "        ylab = 'Embedding dimensions',",
  "        main = 'Embedding–Factor weight structure (Factors 1, 3, 5)')",
  "```",
  "## Factor Enrichment Plots",
  "```{r factor-enrichment, fig.width=12, fig.height=12}",
  "top_n_enrichment <- 3",
  "if (exists('top_factors')) {",
  "  for(f in top_factors) {",
  "    enrichment_plot <- plot_factor_enrichment(f, pathway_collection='hallmark', top_n=top_n_enrichment, all_weights=all_weights)",
  "    if(!is.null(enrichment_plot)) print(enrichment_plot[[1]])",
  "  }",
  "}",
  "```"
), con = rmd_html)
library("kableExtra")
# Render HTML
rmarkdown::render(rmd_html ,output_file = "MOFA_factor_summary_T2.html")
```

```{r}
# =========================================================
# Fast MOFA Factor HTML Report with Precomputed Tables
# =========================================================

rmd_html <- "MOFA_factor_summary_fast.Rmd"

writeLines(c(
  "---",
  "title: '<center>MOFA Factor Analysis: Biological Pathway Associations</center>'",
  "output:",
  "  html_document:",
  "    toc: true",
  "    toc_float: true",
  "    toc_depth: 3",
  "    number_sections: true",
  "    theme: journal",
  "    css: styles.css",
  "    df_print: paged",
  "---",
  "",
  "```{r setup, include=FALSE}",
  "knitr::opts_chunk$set(",
  "  echo = FALSE, warning = FALSE, message = FALSE,",
  "  fig.align = 'center',",
  "  fig.width = 7, fig.height = 5,",
  "  out.width = '100%',",
  "  fig.show = 'asis'",
  ")",
  "library(kableExtra)",
  "library(dplyr)",
  "library(DT)",
  "library(patchwork)",
  "library(ggplot2)",
  "```",
  "",
  "<style>",
  "@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Merriweather:wght@400;700&display=swap');",
  "body { font-family: 'Roboto', sans-serif; line-height: 1.7; color: #2c3e50; background-color: #fafafa; max-width: 1100px; margin: auto; padding: 20px; }",
  "h1, h2, h3 { font-family: 'Merriweather', serif; color: #1a5276; margin-top: 2em; padding-bottom: 0.3em; border-bottom: 2px solid #5dade2; }",
  "table { border-collapse: collapse; margin: 1em 0; }",
  "th { background-color: #5dade2; color: #fff; padding: 8px; text-align: left; }",
  "td { padding: 8px; border-bottom: 1px solid #ddd; }",
  ".table-caption { font-weight: 600; font-size: 1.1em; color: #34495e; margin-bottom: 8px; }",
  "code, pre { font-family: 'Fira Code', monospace; background-color: #f4f6f6; padding: 2px 6px; border-radius: 4px; }",
  "</style>",
  "",
  "# Introduction",
  "MOFA identifies latent factors that capture coordinated variation across multi-omics datasets. This analysis interprets these factors through their associations with curated biological pathways.",
  "",
  "# Data Sources and Pipeline",
  "- **Precomputed Tables**: all_factors_table.rds, enhanced_summary.rds",
  "- **Analysis Methods**: GSEA (preranked), GSVA (sample-level)",
  "",
  "# Latent Factor Tables",
  "",
  "## Summary of Factor Interpretations",
  "```{r summary-table, results='asis'}",
  "all_factors_table <- readRDS('all_factors_table.rds')",
  "if (exists('all_factors_table')) {",
  "  kable(all_factors_table, format = 'html', escape = FALSE,",
  "        caption = '<strong>Table 1: MOFA Factor Biological Interpretations</strong>') %>%",
  "    kable_styling(bootstrap_options = c('striped','hover','condensed'), full_width = TRUE, font_size = 12, position = 'center') %>%",
  "    column_spec(1, bold = TRUE, width = '80px') %>%",
  "    column_spec(2, width = '100px') %>%",
  "    column_spec(3, width = '200px') %>%",
  "    column_spec(4:ncol(all_factors_table), width = '250px') %>%",
  "    scroll_box(width = '100%', height = '500px')",
  "}",
  "```",
  "",
  "## Embedding Correlation Summary",
  "```{r embedding-correlation-table, results='asis'}",
  "enhanced_summary <- readRDS('enhanced_summary.rds')",
  "if (exists('enhanced_summary')) {",
  "  comprehensive_table <- enhanced_summary %>%",
  "    select(Factor = factor, `Best Embedding` = best_embedding, Correlation = correlation,",
  "           `Top Positive Pathway` = top_positive_pathway_clean,",
  "           `Top Negative Pathway` = top_negative_pathway_clean,",
  "           `Top RNA Genes` = top_rna_genes) %>%",
  "    arrange(desc(abs(Correlation)))",
  "",
  "  kable(comprehensive_table, format = 'html', escape = FALSE,",
  "        caption = '<strong>Table 2: Correlations Between MOFA Factors and Image Embeddings</strong>') %>%",
  "    kable_styling(bootstrap_options = c('striped','hover','condensed'), full_width = TRUE, font_size = 12, position = 'center') %>%",
  "    column_spec(1, bold = TRUE, width = '100px') %>%",
  "    column_spec(2, width = '150px') %>%",
  "    column_spec(3, width = '100px') %>%",
  "    column_spec(4:6, width = '250px') %>%",
  "    scroll_box(width = '100%', height = '500px')",
  "}",
  "```"
), con = rmd_html)

# Render HTML
rmarkdown::render(rmd_html, output_file = "MOFA_factor_summarys.html")
```

-   Factor 1 represents a proliferative, MYC-driven program enriched for E2F targets, KRAS signaling, and EMT pathways, reflecting high cell-cycle activity and transcriptional programs associated with tumor growth. In the context of colorectal cancer, it likely marks aggressive, mesenchymal-like tumors with enhanced proliferation, invasion, and metastatic potential.

#### Surv analysis

-   The clinical features have 5 dimensions: T stage, N stage, M stage, total stage, and whether or not to receive chemotherapy after surgery \[1\]

\[1\] Cai, C., Zhou, Y., Jiao, Y. et al. Prognostic Analysis Combining Histopathological Features and Clinical Information to Predict Colorectal Cancer Survival from Whole-Slide Images. Dig Dis Sci 69, 2985–2995 (2024). https://doi-org.ccny-proxy1.libr.ccny.cuny.edu/10.1007/s10620-024-08501-x

```{r}
# ==============================
# Survival Analysis: MOFA + GSVA + Clinical
# ==============================
# -----------------------------
# 1. Load metadata and MOFA factors
# -----------------------------
meta <- samples_metadata(mofa_object.trained)

# Compute survival time
meta$time <- ifelse(meta$vital_status.x == 1, 
                    meta$days_to_death.x,
                    pmax(meta$patient.days_to_last_followup,
                         meta$patient.days_to_last_known_alive,
                         na.rm = TRUE))
meta$time <- pmax(meta$time, 0)  # ensure non-negative
meta$event <- meta$vital_status.x  # 1 = death, 0 = censored

cat("Event counts:\n")
print(table(meta$event, useNA="ifany"))

# -----------------------------
# 2. Kaplan-Meier by histological type
# -----------------------------
km_fit_hist <- survfit(Surv(time, event) ~ patient.stage_event.tnm_categories.pathologic_categories.pathologic_t,
                       data = meta)
ggsurvplot(
  km_fit_hist, data = meta,
  risk.table = TRUE,
  pval = TRUE,
  palette = "Dark2",
  title = "Kaplan-Meier Survival by Histological Type",
  xlab = "Days",
  ylab = "Survival Probability"
)

# -----------------------------
# 3. Extract and align MOFA factors
# -----------------------------
fmat <- get_factors(mofa_object.trained, factors = "all", as.data.frame = FALSE)[[1]]
common_samples <- intersect(rownames(meta), rownames(fmat))
meta2 <- meta[common_samples, , drop = FALSE]
fmat2 <- fmat[common_samples, , drop = FALSE]

# Attach all factors as numeric
for(i in 1:5){
  meta2[[paste0("factor", i)]] <- as.numeric(fmat2[, i])
}

# -----------------------------
# 4. Attach top GSVA pathways per factor
# -----------------------------
# Top 3 pathways per factor from correlation matrix
top_per_factor <- apply(abs(cor_matrix), 1, function(x) names(sort(x, decreasing = TRUE))[1:3])
cand_pathways <- unique(as.vector(top_per_factor))

# Extract these pathways from pathway_df and align
cand_pathways_df <- pathway_df[, cand_pathways, drop=FALSE]
common_samples <- intersect(rownames(meta2), rownames(cand_pathways_df))
meta2 <- meta2[common_samples, ]
cand_pathways_df <- cand_pathways_df[common_samples, ]
meta2 <- cbind(meta2, cand_pathways_df)




```

#### Univariable Cox regression

```{r}
# -----------------------------
# 5. Define candidate variables
# -----------------------------
clinical_vars <- c("age", "sex", "pathology_T_stage", "pathology_N_stage", 
                   "pathology_M_stage", "patient.stage_event.tnm_categories.pathologic_categories.pathologic_t")
factor_vars <- paste0("factor", 1:5)
cand_vars <- c(clinical_vars, factor_vars, cand_pathways)
cand_vars <- cand_vars[cand_vars %in% colnames(meta2)]

# -----------------------------
# 6. Univariable Cox regression
# -----------------------------
univ_results <- lapply(cand_vars, function(v){
  form <- as.formula(paste0("Surv(time, event) ~ `", v, "`"))
  m <- tryCatch(coxph(form, data = meta2), error = function(e) NULL)
  if(is.null(m)) return(data.frame(var=v, HR=NA, p=NA))
  s <- summary(m)
  data.frame(var=v, HR=exp(s$coef[1,"coef"]), p=s$coef[1,"Pr(>|z|)"], stringsAsFactors=FALSE)
})
univ_results <- do.call(rbind, univ_results)
univ_results <- univ_results %>% arrange(p)

# Inspect univariable results
univ_results




```

#### Multivariable Cox regression

```{r}
# -----------------------------
# 7. Multivariable Cox regression
# -----------------------------
# Select top factors, pathways, and clinical covariates based on univariable p < 0.05
top_factors <- c("factor1","factor2","factor3","factor4")  # example
top_pathways <- c("HALLMARK_MITOTIC_SPINDLE",
                  "HALLMARK_PI3K_AKT_MTOR_SIGNALING",
                  "HALLMARK_SPERMATOGENESIS")  # example
clin_vars <- c("pathology_M_stage")  # example
mv_vars <- c(top_factors, top_pathways, clin_vars)
mv_vars <- mv_vars[mv_vars %in% colnames(meta2)]

# Standardize continuous variables for Cox
num_vars <- mv_vars[sapply(meta2_std[, mv_vars], is.numeric)]

for(v in num_vars){
  meta2_std[[v]] <- as.numeric(scale(meta2_std[[v]]))
}

# Fit multivariable Cox model
cox_formula <- as.formula(paste0("Surv(time, event) ~ ", paste(mv_vars, collapse = " + ")))
cox_mv <- coxph(cox_formula, data = meta2_std)
summary(cox_mv)
```
