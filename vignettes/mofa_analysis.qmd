---
title: "Multi-Omics Factor Analysis (MOFA) & preranked Gene Enrichment (GSEA) Cancer Imaging"
format: 
  html:
    theme: yeti
    highlight-style: tango
    toc: true
    toc-depth: 3
    toc-floating: true
editor: visual
execute:
  echo: false
  warning: false
  message: false
  include: false
  results: "hide"
  fig-width: 10
  fig-height: 8
  fig-dpi: 300
---

```{r setup, include=FALSE}
# Load required libraries
library(MOFA2)
library(survival)
library(survminer)
library(curatedTCGAData)
library(fgsea)
library(msigdbr)  
library(enrichplot)
library(ggplot2)
library(dplyr)
library(genekitr)

```



#### Analyze MOFA model

```{r, include =TRUE, echo = TRUE}
#| label: load-mofa
# Load trained MOFA model

mofa_object.trained <- readRDS("mofa_model_with_metadata.rds")
# visualize the model views and samples
plot_data_overview(mofa_object.trained)

# Plot factor correlations to check for interdependence issues with the model
plot_factor_cor(mofa_object.trained)




```

#### Initial visualizations

```{r}
#| label: mofa-visualization
#| warning: false


# Plot variance explained
plot_variance_explained(mofa_object.trained, plot_total = TRUE)



# Plot data heatmaps
# using rna seq view
plot_data_heatmap(mofa_object.trained,
                   scale = "row",
                   cluster_cols = FALSE,
                   cluster_rows = FALSE,
                   show_colnames = FALSE,
                   denoise = TRUE,
                   features = 10,
                   view = "RNASeq",
                   factor=1)

# Using embedding view
plot_data_heatmap(mofa_object.trained,
                  factor = 1,
                  view = "Embedding_layer0",
                  features = 10,
                  cluster_rows = FALSE,
                  cluster_cols = FALSE,
                  show_colnames = FALSE)

# Plot top weights 
plot_top_weights(mofa_object.trained,
                 view = "RNASeq",
                 factor = 1,
                 nfeatures = 10)


# Plot factor colored by pathology stage
plot_factor(mofa_object.trained, 
            factor = 1, 
            add_violin = T,
            dodge = TRUE,
            color_by = "MYH11")

# Plot factor scatter
plot_factor(mofa_object.trained, 
            factor = c(1, 2), 
            color_by = "pathology_T_stage")

plot_top_weights(mofa_object.trained,
                 view = "Embedding_layer0",
                 factor = 1,
                 nfeatures = 10)

# Correlate factors with clinical variables
correlate_factors_with_covariates(mofa_object.trained, 
                      covariates = c("vital_status.x","pathology_M_stage","tumor_tissue_site"), 
                      plot = "log_pval" )

```


#### Surv analysis init

* The clinical features have 5 dimensions: T stage, N stage, M stage, total stage, and whether or not to receive chemotherapy after surgery [1]

[1] Cai, C., Zhou, Y., Jiao, Y. et al. Prognostic Analysis Combining Histopathological Features and Clinical Information to Predict Colorectal Cancer Survival from Whole-Slide Images. Dig Dis Sci 69, 2985–2995 (2024). https://doi-org.ccny-proxy1.libr.ccny.cuny.edu/10.1007/s10620-024-08501-x




```{r, include=TRUE, echo=TRUE}


# Use the matched metadata already aligned to MOFA
meta <- samples_metadata(mofa_object.trained)

# Compute survival time (days)
meta$time <- ifelse(meta$vital_status.x == 1,  # 1 = deceased
                    meta$patient.days_to_last_followup,
                    meta$patient.days_to_last_known_alive)


# Check NA counts
sapply(meta[, c("days_to_death.x", 
                "patient.days_to_last_followup", 
                "patient.days_to_last_known_alive")], 
       function(x) sum(is.na(x)))
names(meta)


# Ensure non-negative times
meta$time <- pmax(meta$time, 0)

# Event indicator: 1 = death, 0 = censored
meta$event <- meta$vital_status.x  # already numeric 1=death, 0=censored
# Diagnostics
cat("Event counts:\n"); print(table(meta$event, useNA="ifany"))

# --------------------------
# 1. KM by histological type
# --------------------------
km_fit_hist <- survfit(Surv(time, event) ~ pathology_M_stage  ,
                       data = meta)

ggsurvplot(
  km_fit_hist,
  data = meta,
  risk.table = TRUE,
  pval = TRUE,
  palette = "Dark2",
  title = "Kaplan-Meier Survival by Gender",
  xlab = "Days",
  ylab = "Survival Probability"
)

# --------------------------
# 2. surv by MOFA Factor1
# --------------------------

# -------------------------------
# Extract MOFA factors and align with metadata
# -------------------------------
fmat <- get_factors(mofa_object.trained, factors = "all", as.data.frame = FALSE)[[1]]

# Keep only common samples between MOFA factors and metadata
common_samples <- intersect(rownames(meta), rownames(fmat))
cat("Common samples between metadata and MOFA factors:", length(common_samples), "\n")

meta2 <- meta[common_samples, , drop = FALSE]
fmat2 <- fmat[common_samples, , drop = FALSE]

# Attach Factor1 as numeric
meta2$factor1 <- as.numeric(fmat2[, 1])

# -------------------------------
# Subset to usable samples
# -------------------------------
meta_use <- meta2 %>% filter(!is.na(time) & !is.na(event))
cat("Usable samples after filtering:", nrow(meta_use), "\n")

# -------------------------------
# Create survival object
# -------------------------------
surv_obj <- Surv(time = meta_use$time, event = meta_use$event)

# Fit survival model using Factor1 as continuous variable
cox_fit <- coxph(surv_obj ~ factor1, data = meta_use)
summary(cox_fit)

```



#### Fast preranked gene set enrichment analysis (GSEA)

```{r, GSEA, include=TRUE, echo=TRUE}
# Extract weights for Factor 1 in RNASeq
# we extracted the feature weights for the top contributing genes in the rnaseq view, which represent the genes most associated with factor 1
weights <- get_weights(mofa_object.trained, 
                       views = "RNASeq", 
                       factors = 1, 
                       as.data.frame = TRUE)

# Make named vector of weights
ranks <- weights$value
names(ranks) <- weights$feature

# Order decreasing
ranks <- sort(ranks, decreasing = TRUE)

# get Hallmark gene sets
#50 curated gene sets representing broad, well-defined biological processes (e.g., MYC targets, E2F targets, KRAS signaling, apoptosis)
pathways_hallmark <- msigdbr(species = "Homo sapiens", category = "H") %>%
  split(x = .$gene_symbol, f = .$gs_name)

# get c2 gene sets
# Gene sets representing signatures of oncogene activation or inactivation (e.g., KRAS, MYC, E2F, PTEN loss).
pathways_c6 <- msigdbr(species = "Homo sapiens", category = "C6") %>%
  split(x = .$gene_symbol, f = .$gs_name)

# get c2 gene sets
#Pathway databases and expert-curated gene sets, subdivided into:
##CGP (chemical/genetic perturbations) → genes responsive to drugs or perturbations.
##CP (canonical pathways) → pathways from KEGG, Reactome, BioCarta.
pathways_c2 <- msigdbr(species = "Homo sapiens", category = "C2") %>%
  split(x = .$gene_symbol, f = .$gs_name)


```



## Run FGSEA
```{r}

# Run preranked GSEA
#gene set enrichment analysis (GSEA) to identify biological pathways and programs associated with the latent factors
fgseaRes <- fgsea(pathways = pathways_c6,
                  stats    = ranks,
                  minSize  = 15,
                  maxSize  = 500)

# Show top pathways
fgseaRes[order(fgseaRes$pval), ][1:10, ]

# Arrange the output
fgseaResTidy <- fgseaRes %>%
  arrange(NES) %>%
  mutate(pathway = factor(pathway, levels = rev(unique(pathway))))

```

**Explanation of GSEA output (fgsea):**

- **pathway** – Name of the gene set tested (e.g., Hallmark pathways).  
- **pval** – Raw p-value from the enrichment test.  
- **padj** – Adjusted p-value (FDR corrected).  
- **ES (Enrichment Score)** – Degree to which a gene set is overrepresented at the top or bottom of the ranked list.  
- **NES (Normalized Enrichment Score)** – Enrichment score normalized for gene set size, used to compare across gene sets.  
- **size** – Number of genes in the pathway that overlap with the ranked list.  
- **leadingEdge** – Subset of genes that contribute most to the enrichment signal. 


```{r}
# Testing out genSEA
# # Make a named vector of weights
# ranks <- weights$value
# names(ranks) <- weights$feature
# 
# # Order the vector in decreasing order (this is crucial for GSEA)
# ranks <- sort(ranks, decreasing = TRUE)
# 
# # --- Step 2: Prepare the Hallmark gene sets for genGSEA ---
# # This is the corrected step. You must include the `gs_description` column.
# 
# pathways_for_gensea <- msigdbr(species = "Homo sapiens", category = "H") %>%
#   select(gs_name, gene_symbol, gs_description) %>%
#   rename(term = gs_name, gene = gene_symbol)
# 
# # --- Step 3: Run the GSEA analysis using genGSEA() ---
# 
# # Run the analysis using the ranked list and the formatted gene sets
# gensea_results <- genGSEA(
#   genelist = ranks,
#   geneset = pathways_for_gensea,
#   min_gset_size = 15,
#   max_gset_size = 500
# )

```




#### Visualize fGSEA


* gsea table
```{r, include=TRUE}

# Generates a clean table for reporting
plotGseaTable(
  fgseaRes = fgseaResTidy,
  stats = ranks,     # your MOFA factor loadings
  pathways = pathways
)


```


* barplot

```{r, include=TRUE}

ggplot(fgseaResTidy, aes(x = pathway, y = NES)) +
  geom_col(aes(fill = padj < 0.05)) +
  coord_flip() +
  labs(
    x = "Pathway",
    y = "Normalized Enrichment Score (NES)",
    title = "Hallmark Pathways from GSEA",
    fill = "FDR < 0.05"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.y = element_text(size = 10)
  )


```

- Hallmark pathways from the GSEA results, ranked by normalized enrichment score (NES), with bars colored by whether the adjusted p-value (FDR) is significant (< 0.05).

- MYC targets (V1, V2), E2F targets, and KRAS signaling are strongly negatively enriched, suggesting suppression of cell-cycle–related and oncogenic signaling programs in the context of the factors identified by MOFA. 

- epithelial–mesenchymal transition (EMT), inflammatory response, interferon gamma response, and allograft rejection. This points to activation of immune and stromal programs.


* dotplot

```{r, include=TRUE}

# Dotplot
ggplot(fgseaResTidy, aes(x = NES, y = pathway)) +
  geom_point(aes(size = size, color = -log10(padj))) +
  scale_color_gradient(low = "blue", high = "red") +
  labs(
    x = "Normalized Enrichment Score (NES)",
    y = "Pathway",
    title = "Hallmark Pathways Enriched (GSEA)",
    size = "Gene Set Size",
    color = "-log10(FDR q-value)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.y = element_text(size = 10)
  )
```




* Plotting the top path

```{r, include=TRUE}
# Picking the top path (MYC targets V1)
top_path <- fgseaResTidy$pathway[1]

plotEnrichment(pathways[[top_path]], ranks) +
  labs(title = paste("Enrichment Curve:", top_path))



```







