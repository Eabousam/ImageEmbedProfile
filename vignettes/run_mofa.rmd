---
title: "CRC Image Feature Analysis"
format:
  html:
    theme: yeti
    highlight-style: tango
    toc: true
    toc-depth: 3
    toc-floating: true
---

## Image Analysis: TCGAData

#### Setting up libraries

```{r}
#| output: False
library(rmarkdown)
library(knitr)
library(psych)
library(imageFeatureTCGA)
library(curatedTCGAData)
library(SummarizedExperiment)
library(dplyr)
library(MOFA2)
library(TCGAutils)
library(ggplot2)
```

#### prov-gigaPath Cancer WSI MOFA2


# Load slide data catalog

```{r load embeddings}
catalog_coad <- getCatalog("provgigapath") |> 
    dplyr::filter(level == "slide_level", Project.ID == "TCGA-COAD") |>
     dplyr::slice(1:n())

ov_catalog <- getCatalog("provgigapath") |> 
    dplyr::filter(level == "slide_level", Project.ID == "TCGA-OV") |>
  dplyr::slice(1:n())

```

# Read Ovarian Cancer assay with curatedTCGA

```{r load_rnaseq, message=FALSE}
#------------------------------------------
# Load OV assays
#------------------------------------------

OV_mae_all <- curatedTCGAData(
  diseaseCode = "OV",
  assays = "*",
  version = "2.1.1",
  dry.run = FALSE
)

OV_assays_subset <- c(
    "OV_RNASeq2GeneNorm-20160128", # Gene expression (mRNA abundance).
    "OV_RPPAArray-20160128", # Methylation (Epigenetic regulation of gene expression.)
    #"OV_RPPAArray-20160128",# Proteomics (Protein abundance and phosphorylation levels (~200 proteins).)
    "OV_GISTIC_AllByGene-20160128") # Discrete copy number changes per gene (−2 deletion → +2 amplification).
ov_mae <- OV_mae_all[,,which(names(OV_mae_all) %in% OV_assays_subset)]



#------------------------------------------
# Load COAD assays
#------------------------------------------

COAD_mae_all <- curatedTCGAData(
  diseaseCode = "COAD",
  assays = "*",
  version = "2.1.1",
  dry.run = FALSE
)
COAD_assays_subset <- c("COAD_GISTIC_AllByGene-20160128", # (copy number)
    "COAD_RNASeq2GeneNorm-20160128", # RNAseq
    "COAD_RPPAArray-20160128")# Proteomics

COAD_mae <- COAD_mae_all[,,which(names(COAD_mae_all) %in% COAD_assays_subset)]

```

```{r}
# check intersecting patients

common_prim <- Reduce(intersect, list(
    TCGAutils::TCGAbarcode(colnames(OV_mae_all[["OV_RNASeq2GeneNorm-20160128"]])),
    TCGAutils::TCGAbarcode(colnames(OV_mae_all[["OV_RPPAArray-20160128"]])),
    TCGAutils::TCGAbarcode(colnames(OV_mae_all[["OV_RNASeq2GeneNorm-20160128"]]))
))
```



# Link OV and COAD MAE data to the MultiAssayExperiment using linkTCGA

```{r linktcga}
# OV mae DATA
ov_mae_emb <-
    linkTCGA(ov_mae, ov_catalog, redownload = FALSE, parallel = FALSE)

## create artificial rownames for MOFA2
rownames(ov_mae_emb[["slide_assay"]]) <-
    paste0("slide_feat_", seq_len(nrow(ov_mae_emb[["slide_assay"]])))

slide_samples <- colnames(ov_mae_emb[["slide_assay"]])


## Make sure the assays align
ov_mae_emb_aligned <- list()
for (nm in names(experiments(ov_mae_emb))) {
  se <- experiments(ov_mae_emb)[[nm]]
  mat <- assay(se)  # extract the assay matrix
  
  # Create a new matrix with the same rows but only slide_samples columns, filled with NA
  new_mat <- matrix(NA, 
                    nrow = nrow(mat), 
                    ncol = length(slide_samples),
                    dimnames = list(rownames(mat), slide_samples))
  
  # Find columns in this assay that correspond to slide samples
  common <- intersect(colnames(mat), slide_samples)
  if (length(common) > 0) {
    new_mat[, common] <- mat[, common, drop = FALSE]
  }
  
  # To make sure they're all numeric (GSIC was character), convert to numeric if needed
  if (!is.numeric(new_mat)) {
    new_mat <- matrix(as.numeric(new_mat), 
                      nrow = nrow(new_mat), 
                      dimnames = dimnames(new_mat))
  }
  
  ov_mae_emb_aligned[[nm]] <- new_mat
}



```

```{r}
# COAD MAE dats
coad_mae_emb <-
    linkTCGA(COAD_mae, catalog_coad, redownload = TRUE, parallel = TRUE)

## create artificial rownames for MOFA2
rownames(coad_mae_emb[["slide_assay"]]) <-
    paste0("slide_feat_", seq_len(nrow(coad_mae_emb[["slide_assay"]])))

## Make sure the assays align
coad_mae_emb_aligned <- list()
for (nm in names(experiments(coad_mae_emb))) {
  se <- experiments(coad_mae_emb)[[nm]]
  mat <- assay(se)  # extract the assay matrix
  
  # Create a new matrix with the same rows but only slide_samples columns, filled with NA
  new_mat <- matrix(NA, 
                    nrow = nrow(mat), 
                    ncol = length(slide_samples),
                    dimnames = list(rownames(mat), slide_samples))
  
  # Find columns in this assay that correspond to slide samples
  common <- intersect(colnames(mat), slide_samples)
  if (length(common) > 0) {
    new_mat[, common] <- mat[, common, drop = FALSE]
  }
  
  # To make sure they're all numeric (GSIC was character), convert to numeric if needed
  if (!is.numeric(new_mat)) {
    new_mat <- matrix(as.numeric(new_mat), 
                      nrow = nrow(new_mat), 
                      dimnames = dimnames(new_mat))
  }
  
  coad_mae_emb_aligned[[nm]] <- new_mat
}


```



# Run MOFA

```{r run_mofa}
# Create MOFA object from MultiAssayExperiment
mofa_obj <- create_mofa(ov_mae_emb_aligned)

# Set data options
data_opts <- get_default_data_options(mofa_obj)

# Set model options
model_opts <- get_default_model_options(mofa_obj)
model_opts$num_factors <- 15  # the default

# Set training options
train_opts <- get_default_training_options(mofa_obj)

# currently set to fast for vignette rendering speed but slow is recommended
train_opts$convergence_mode <- "fast" 

train_opts$seed <- 42

# Prepare the model
mofa_obj <- prepare_mofa(
    object = mofa_obj,
    data_options = data_opts,
    model_options = model_opts,
    training_options = train_opts
)

# Train the model
mofa_obj.trained <- run_mofa(
    mofa_obj,
    outfile = "mofa_model_ovarian.hdf5" ,
    use_basilisk = TRUE
)
```


```{r}
# 1. Verify that no matrix has zero rows after removing all‑NA features
for (nm in names(ov_mae_emb_aligned)) {
  mat <- ov_mae_emb_aligned[[nm]]
  keep <- rowSums(!is.na(mat)) > 0
  cat(nm, ": ", sum(!keep), " all‑NA rows\n")
  ov_mae_emb_aligned[[nm]] <- mat[keep, , drop = FALSE]
}
# If any view now has 0 rows, that view is the culprit.

# 2. Check that all matrices are numeric and have no constant rows (zero variance)
for (nm in names(ov_mae_emb_aligned)) {
  mat <- ov_mae_emb_aligned[[nm]]
  sds <- apply(mat, 1, sd, na.rm = TRUE)
  constant <- is.na(sds) | sds == 0
  cat(nm, ": ", sum(constant), " constant rows\n")
  # Optionally remove them
  ov_mae_emb_aligned[[nm]] <- mat[!constant, , drop = FALSE]
}

# 3. Confirm that the slide_assay has no NAs (should be complete)
cat("NAs in slide_assay:", sum(is.na(ov_mae_emb_aligned$slide_assay)), "\n")


views <- names(ov_mae_emb_aligned)
for (v in views) {
  cat("Testing without", v, "\n")
  temp <- try(create_mofa(ov_mae_emb_aligned[setdiff(views, v)]), silent = TRUE)
  if (inherits(temp, "try-error")) {
    cat("  Failed when removing", v, "\n")
  } else {
    cat("  Succeeded when removing", v, " – the issue is with view", v, "\n")
  }
}
```


# Visualize MOFA results

```{r load and visualize the model}
mofa_object.trained <- load_model("mofa_model_coad.hdf5 2")

plot_variance_explained(mofa_object.trained)
```




