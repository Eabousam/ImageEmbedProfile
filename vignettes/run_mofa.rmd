---
title: "CRC Image Feature Analysis"
format:
  html:
    theme: yeti
    highlight-style: tango
    toc: true
    toc-depth: 3
    toc-floating: true
---

## Image Analysis: TCGAData

#### Setting up libraries

```{r}
#| output: False
library(rmarkdown)
library(knitr)
library(psych)
library(imageFeatureTCGA)
library(curatedTCGAData)
library(SummarizedExperiment)
library(dplyr)
library(MOFA2)
library(TCGAutils)
library(ggplot2)
```

#### prov-gigaPath Cancer WSI MOFA2


# Load slide data catalog

```{r load embeddings}
catalog_coad <- getCatalog("provgigapath") |> 
    dplyr::filter(level == "slide_level", Project.ID == "TCGA-COAD") |>
     dplyr::slice(1:n())

ov_catalog <- getCatalog("provgigapath") |> 
    dplyr::filter(level == "slide_level", Project.ID == "TCGA-OV") |>
  dplyr::slice(1:n())

```

# Read Ovarian Cancer assay with curatedTCGA

```{r load_rnaseq, message=FALSE}
#------------------------------------------
# Load OV assays
#------------------------------------------

OV_mae_all <- curatedTCGAData(
  diseaseCode = "OV",
  assays = "*",
  version = "2.1.1",
  dry.run = FALSE
)

OV_assays_subset <- c(
    "OV_RNASeq2GeneNorm-20160128", # Gene expression (mRNA abundance).
    "OV_RPPAArray-20160128", # Methylation (Epigenetic regulation of gene expression.)
    #"OV_RPPAArray-20160128",# Proteomics (Protein abundance and phosphorylation levels (~200 proteins).)
    "OV_GISTIC_AllByGene-20160128") # Discrete copy number changes per gene (−2 deletion → +2 amplification).
ov_mae <- OV_mae_all[,,which(names(OV_mae_all) %in% OV_assays_subset)]



#------------------------------------------
# Load COAD assays
#------------------------------------------

COAD_mae_all <- curatedTCGAData(
  diseaseCode = "COAD",
  assays = "*",
  version = "2.1.1",
  dry.run = FALSE
)
COAD_assays_subset <- c("COAD_GISTIC_AllByGene-20160128", # (copy number)
    "COAD_RNASeq2GeneNorm-20160128", # RNAseq
    "COAD_RPPAArray-20160128")# Proteomics

COAD_mae <- COAD_mae_all[,,which(names(COAD_mae_all) %in% COAD_assays_subset)]

```



# Link OV and COAD MAE data to the MultiAssayExperiment using linkTCGA

```{r linktcga}
# OV mae DATA
ov_mae_emb <-
    linkTCGA(ov_mae, ov_catalog, redownload = FALSE, parallel = FALSE)

## create artificial rownames for MOFA2
rownames(ov_mae_emb[["slide_assay"]]) <-
    paste0("slide_feat_", seq_len(nrow(ov_mae_emb[["slide_assay"]])))

# ---- 1. Get patients with slide data ----
slide_sm <- sampleMap(ov_mae_emb)[sampleMap(ov_mae_emb)$assay == "slide_assay", ]
patients <- unique(slide_sm$primary)

# ---- 2. Prepare list to hold patient-level matrices ----
ov_mae_emb_aligned <- list()

# ---- 3. Process each assay ----
for (nm in names(experiments(ov_mae_emb))) {
  cat("Processing", nm, "\n")
  se <- experiments(ov_mae_emb)[[nm]]
  mat <- assay(se)                     # features x samples matrix
  
  # Get sampleMap for this assay
  sm <- sampleMap(ov_mae_emb)[sampleMap(ov_mae_emb)$assay == nm, ]
  
  # Map each column to patient
  col_patients <- sm$primary[match(colnames(mat), sm$colname)]
  
  # Create empty patient matrix (features x patients)
  patient_mat <- matrix(NA, 
                        nrow = nrow(mat), 
                        ncol = length(patients),
                        dimnames = list(rownames(mat), patients))
  
  # For each patient, average columns belonging to that patient
  for (pat in patients) {
    cols <- which(col_patients == pat)
    if (length(cols) == 1) {
      patient_mat[, pat] <- mat[, cols]
    } else if (length(cols) > 1) {
      patient_mat[, pat] <- rowMeans(mat[, cols, drop = FALSE], na.rm = TRUE)
    }
    # else: no data -> stays NA
  }
  
  # Convert to numeric if needed (GISTIC sometimes character)
  if (!is.numeric(patient_mat)) {
    patient_mat <- matrix(as.numeric(patient_mat),
                          nrow = nrow(patient_mat),
                          dimnames = dimnames(patient_mat))
  }
  
  # Remove features that are all NA
  keep <- rowSums(!is.na(patient_mat)) > 0
  patient_mat <- patient_mat[keep, , drop = FALSE]
  
  ov_mae_emb_aligned[[nm]] <- patient_mat
}



```

```{r}
# COAD MAE dats
coad_mae_emb <-
    linkTCGA(COAD_mae, catalog_coad, redownload = TRUE, parallel = TRUE)

## create artificial rownames for MOFA2
rownames(coad_mae_emb[["slide_assay"]]) <-
    paste0("slide_feat_", seq_len(nrow(coad_mae_emb[["slide_assay"]])))

slide_sm <- sampleMap(coad_mae_emb)[sampleMap(coad_mae_emb)$assay == "slide_assay", ]
patients_with_slide <- unique(slide_sm$primary)   # these are the patients we care about

# 2. Prepare an empty list for patient-level matrices
coad_mae_emb_aligned <- list()

# 3. Loop over all assays
for (nm in names(experiments(coad_mae_emb))) {
  se <- experiments(coad_mae_emb)[[nm]]
  mat <- assay(se)   # features x samples
  
  # Get sampleMap for this assay
  sm <- sampleMap(coad_mae_emb)[sampleMap(coad_mae_emb)$assay == nm, ]
  
  # Map each column to patient
  col_patients <- sm$primary[match(colnames(mat), sm$colname)]
  
  # Create empty patient matrix (features x patients_with_slide)
  pat_mat <- matrix(NA, 
                    nrow = nrow(mat), 
                    ncol = length(patients_with_slide),
                    dimnames = list(rownames(mat), patients_with_slide))
  
  # For each patient, average columns belonging to that patient
  for (pat in patients_with_slide) {
    cols <- which(col_patients == pat)
    if (length(cols) == 1) {
      pat_mat[, pat] <- mat[, cols]
    } else if (length(cols) > 1) {
      pat_mat[, pat] <- rowMeans(mat[, cols, drop = FALSE], na.rm = TRUE)
    }
    # else: no data -> stays NA
  }
  
  # Convert to numeric if needed
  if (!is.numeric(pat_mat)) {
    pat_mat <- matrix(as.numeric(pat_mat), 
                      nrow = nrow(pat_mat), 
                      dimnames = dimnames(pat_mat))
  }
  
  # Remove features that are all NA
  keep <- rowSums(!is.na(pat_mat)) > 0
  pat_mat <- pat_mat[keep, , drop = FALSE]
  
  coad_mae_emb_aligned[[nm]] <- pat_mat
}


```



# Run MOFA

```{r run_mofa}
# Create MOFA object from MultiAssayExperiment
mofa_obj <- create_mofa(coad_mae_emb_aligned)

# Set data options
data_opts <- get_default_data_options(mofa_obj)

# Set model options
model_opts <- get_default_model_options(mofa_obj)
model_opts$num_factors <- 15  # the default

# Set training options
train_opts <- get_default_training_options(mofa_obj)

# currently set to fast for vignette rendering speed but slow is recommended
train_opts$convergence_mode <- "fast" 

train_opts$seed <- 42

# Prepare the model
mofa_obj <- prepare_mofa(
    object = mofa_obj,
    data_options = data_opts,
    model_options = model_opts,
    training_options = train_opts
)

# Train the model  
mofa_obj.trained <- run_mofa(
    mofa_obj,
    outfile = "mofa_model_colon.hdf5" ,
    use_basilisk = TRUE
)
```




# Visualize MOFA results

```{r load and visualize the model}
mofa_object.trained <- load_model("mofa_model_ovarian.hdf5")

plot_variance_explained(mofa_object.trained)
```





